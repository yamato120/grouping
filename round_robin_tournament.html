<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>

    <title>総当たり戦</title>
</head>

<body>
    <h2>総当たり戦作成ツール</h2>
    <h3>(i)選手登録</h3>
    <input type="button" id="cookie" value="前回のデータを読み込む" onclick="cookie_set()">
    <input type="button" id="done" value="実行" onclick="round_robin()">
    <input type="button" id="delete" value="クリア" onclick="deleteForm()">
    <br>
    <textarea rows="16" id="text" placeholder="1人ずつ改行して入力" oninput="">
player1
player2
player3
player4
player5
player6
</textarea>
    <h3>(ii)表</h3>
    <table class="design01" id="table">
    </table><br>
    <input type="button" id="load" value="更新" onclick="set_table()">
    <h3>(iii)対戦順</h3>
    <table id="order">
    </table>
</body>

</html>
<script>
    function cookie_set() {
        var cookie = Cookies.get('text');
        if (cookie != undefined) {
            document.getElementById("text").value = cookie;
        }
        console.log(cookie);
    }

    function round_robin() {
        // 表出力
        set_table();

        var text = document.getElementById("text").value.trimStart();
        var text = document.getElementById("text").value.trimEnd();
        var member = text.split(/\n/);
        var len = member.length;    // 人数
        var i, n;

        if(member[0]==""){
            alert("入力エラー");
            exit(1);
        }

        // プレイヤー配列 1,2,4,8,16,...,len
        var list = new Array(len);
        for (i = 0; i < len; i++) {
            // 属性付与 list.num:番号 list.name:名前
            list[i] = new Object();
            list[i].num = 2 ** i;
            list[i].name = member[i];
            //console.log(list[i].num);
            //console.log(list[i].name);
        }

        var order = [];   // 対戦順 list.num の和で組み合わせを表現

        for (i = 0; i < len; i++) {
            for (j = 0; j < i; j++) {
                order.push(list[i].num + list[j].num);
            }
        }

        while (1) {
            // 2opt法で改善
            var optcnt = two_opt(order);
            // 一点交換法で改善
            var chgcnt = exchange(order);
            if (optcnt == chgcnt) break;
        }
        rnd_two_opt(order);


        // 対戦順出力
        print_order(order, list);


        Cookies.set('locale', 'ja-JP'); //ユーザーの使用言語を日本語に指定
        Cookies.set('text', text, {expires: 30});
    }

    function set_table() {
        var table = document.getElementById("table");
        var text = document.getElementById("text").value.trimEnd();
        var member = text.split(/\n/);
        var idNum;

        // 一度tableを初期化（全削除）する
        while (table.rows.length > 0) table.deleteRow(0);

        var i, j;
        var n;  //人数
        var sum;
        n = member.length;
        for (i = 0; i < n + 1; i++) {
            // 行生成
            var tr = document.createElement('tr');
            
            sum=0;
            for (j = 0; j < n + 2; j++) {
                if (i == 0) { // 1行目の処理
                    var th = document.createElement('th');
                    if (j == 0) {
                        th.innerHTML = "";
                    } else if(j<n+1){
                        th.innerHTML = member[j - 1];
                    }else{
                        th.innerHTML = "合計";
                    }
                    tr.appendChild(th);
                } else {    // 2行目以降の処理
                    if (j == 0) {   // 1列目（名前）
                        var th = document.createElement('th');
                        th.innerHTML = member[i - 1];
                        tr.appendChild(th);
                    } else if(j<n+1){    // 2列目以降
                        var td = document.createElement('td');
                        td.id = (i - 1) + "_" + (j - 1);   //id付与 id="y_x"
                        if (i == j) {
                            td.classList.add("border");
                        } else {
                            if (idNum = document.getElementById('in' + (i - 1) + '_' + (j - 1))) {
                                td.innerHTML = idNum.value;
                                sum+=Number(idNum.value);
                            } else {
                                td.innerHTML = "";
                            }
                        }
                        tr.appendChild(td);
                    }else{
                        var td = document.createElement('td');
                        td.innerHTML=sum;
                        tr.appendChild(td);
                    }
                }
            }
            table.appendChild(tr);
        }
    }

    function print_order(order, list) {
        var tbl = document.getElementById("order");
        let flg;
        let combo = [2];

        // 一度tableを初期化（全削除）する
        while (tbl.rows.length > 0) tbl.deleteRow(0);

        let len = list.length;
        // 対戦順を復元
        for (i = 0; i < order.length; i++) {
            flg = 0;
            // 行生成
            var tr = document.createElement('tr');
            // 1列目生成
            var th = document.createElement('th');
            th.innerHTML = "第" + (i + 1) + "試合";
            tr.appendChild(th);
            for (j = 0; j < len; j++) {
                // orderと0000 0001の論理積を取る
                if (order[i] & 0x01 == 1) {
                    combo[flg] = j;
                    if (flg == 1) break;
                    flg = 1;
                }
                // 1bit右シフト
                order[i] = order[i] >> 1;
            }
            // 生成

            // 1人目 名前
            var td = document.createElement('td');
            td.innerHTML = list[combo[0]].name;
            tr.appendChild(td);
            // 1人目 得点
            td = document.createElement('td');
            const input1 = document.createElement("input");
            input1.setAttribute("type", "text");
            input1.setAttribute("maxlength", "5");
            input1.setAttribute("size", "1");
            input1.id = 'in' + combo[0] + '_' + combo[1];
            td.appendChild(input1);
            tr.appendChild(td);
            // vs
            td = document.createElement('td');
            td.innerHTML = 'vs';
            tr.appendChild(td);
            // 2人目 得点
            td = document.createElement('td');
            const input2 = document.createElement("input");
            input2.setAttribute("type", "text");
            input2.setAttribute("maxlength", "5");
            input2.setAttribute("size", "1");
            input2.id = 'in' + combo[1] + '_' + combo[0];
            td.appendChild(input2);
            tr.appendChild(td);
            // 2人目 名前
            td = document.createElement('td');
            td.innerHTML = list[combo[1]].name;
            tr.appendChild(td);

            tr.appendChild(td);

            tbl.appendChild(tr);
        }
    }

    function two_opt(order) {
        var i, j, n, i2, j2;
        var temp, before, after;
        var count = 0, flg = 0;
        while (flg == 0) {
            count++;
            if (count > 100000) flg = 1;
            before = evaluate(order);
            for (i = 0; i < order.length; i++) {
                for (j = 0; j < order.length; j++) {
                    if (i != j) {
                        i2 = i;
                        j2 = j;
                        //選ばれた点と繋ぎなおす
                        for (; i2 < j2; i2++, j2--) {
                            temp = order[i2];
                            order[i2] = order[j2];
                            order[j2] = temp;
                        }
                        after = evaluate(order);
                        if (before < after) {
                            i2 = i;
                            j2 = j;
                            //戻す
                            for (; i2 < j2; i2++, j2--) {
                                temp = order[i2];
                                order[i2] = order[j2];
                                order[j2] = temp;
                            }
                        } else {
                            if (after == 1) flg = 1;
                        }
                    }
                }
            }
        }
        return count;
    }

    function exchange(order) {
        var i, j, n, i2, j2;
        var temp, before, after;
        var count = 0, flg = 0;
        while (flg == 0) {
            count++;
            if (count > 100000) flg = 1;
            before = evaluate(order);
            for (i = 0; i < order.length; i++) {
                for (j = 0; j < order.length; j++) {
                    if (i != j) {
                        //選ばれた点と交換
                        temp = order[i];
                        order[i] = order[j];
                        order[j] = temp;
                        after = evaluate(order);
                        if (before < after) {
                            i = i;
                            j = j;
                            //戻す
                            temp = order[i];
                            order[i] = order[j];
                            order[j] = temp;
                        } else {
                            if (after == 1) flg = 1;
                        }
                    }
                }
            }
        }
        return count;
    }

    function rnd_two_opt(order) {
        var i, j, n, i2, j2;
        var temp, before, after;
        var count = 0, flg = 0;
        while (1) {
            for (i = 0; i < order.length - 1; i++) {
                if ((order[i] & order[i + 1]) > 0) {
                    do {
                        var j = Math.floor(Math.random() * (order.length + 1));
                    } while (j == i || j == i + 1)
                }
                before = evaluate(order);
                if (i != j) {
                    i2 = i;
                    j2 = j;
                    //選ばれた点と繋ぎなおす
                    for (; i2 < j2; i2++, j2--) {
                        temp = order[i2];
                        order[i2] = order[j2];
                        order[j2] = temp;
                    }
                    after = evaluate(order);
                    if (before < after) {
                        i2 = i;
                        j2 = j;
                        //戻す
                        for (; i2 < j2; i2++, j2--) {
                            temp = order[i2];
                            order[i2] = order[j2];
                            order[j2] = temp;
                        }
                    } else {
                    }
                }
            }
            if (after == 1) break;
            count++;
            if (count > 100) break;
        }
        return count;
    }

    function rnd_exchange(order) {
        var i, j, n, i2, j2;
        var temp, before, after;
        var count = 0, flg = 0;
        while (flg == 0) {
            count++;
            if (count > 100000) flg = 1;
            before = evaluate(order);
            for (i = 0; i < order.length; i++) {
                for (j = 0; j < order.length; j++) {
                    if (i != j) {
                        //選ばれた点と交換
                        temp = order[i];
                        order[i] = order[j];
                        order[j] = temp;
                        after = evaluate(order);
                        if (before < after) {
                            i = i;
                            j = j;
                            //戻す
                            temp = order[i];
                            order[i] = order[j];
                            order[j] = temp;
                        } else {
                            if (after == 1) flg = 1;
                        }
                    }
                }
            }
        }
        return count;
    }

    function evaluate(order) {
        var flg = 1;
        var max = 0;
        var total = 1;
        for (var i = 0; i < order.length - 1; i++) {
            if ((order[i] & order[i + 1]) > 0) {
                flg++;
                total++;
            } else {
                flg = 1;
            }
            if (flg > max) max = flg;
        }
        console.log('最大連戦数：' + max);
        console.log('総合連戦数：' + total);
        return total;
    }

    function deleteForm() {
        document.getElementById("text").value = "";
        while (document.getElementById("table").rows.length > 0) document.getElementById("table").deleteRow(0);
        while (document.getElementById("order").rows.length > 0) document.getElementById("order").deleteRow(0);
    }

    function getRandom(min, max) {
        var random = Math.floor(Math.random() * (max + 1 - min)) + min;
        return random;
    }
</script>

<style>
    #text {
        resize: none;
        overflow: hidden;
    }


    .design01 {
        margin-top: 10px;
        width: auto;
        table-layout: fixed;
        text-align: center;
        border-collapse: collapse;
        border-spacing: 0;
    }

    .design01 th {
        padding: 10px;
        width: 6em;
        background: #e9faf9;
        border: solid 1px #778ca3;
    }

    .design01 td {
        padding: 10px;
        border: solid 1px #778ca3;
    }

    .border {
        background-image: linear-gradient(to right top, transparent calc(50% - 0.5px), #999 50%, #999 calc(50% + 0.5px), transparent calc(50% + 1px))
    }
</style>